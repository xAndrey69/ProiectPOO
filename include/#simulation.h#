#ifndef SIMULATION_H
#define SIMULATION_H

#include "config.h"
#include "map.h"
#include "agents.h"
#include "hivemind.h"
#include <vector>
#include <fstream>
#include <string>
#include <memory> 

class Simulation {
private:
  
    std::unique_ptr<Map> map;
    std::vector<std::unique_ptr<Agent>> agents;
    std::vector<std::unique_ptr<Package>> packages;
    std::unique_ptr<HiveMind> hiveMind;
    std::unique_ptr<ProceduralMapGenerator> mapGenerator;
    
    int currentTick;
    int totalTicks;
    
    long long totalRevenue;
    long long totalCosts;
    long long totalPenalties;
    
    int packagesDelivered;
    int packagesFailed;
    int agentsLost;
    int agentsAlive;
    
    std::ofstream logFile;
    bool enableLogging;
    
    void initializeSimulation();
    void generateInitialAgents();
    void spawnPackages();
    void updateAgents();
    void processDeliveries();
    void checkAgentStatus();
    void logEvent(const std::string& message);
    void saveStatistics();
    
public:
    Simulation(bool enableLog = false);
    ~Simulation();
    
    void initialize();
    void run();
    void printFinalReport() const;
    
    long long getTotalProfit() const { return totalRevenue - totalCosts - totalPenalties; }
    int getPackagesDelivered() const { return packagesDelivered; }
    int getAgentsLost() const { return agentsLost; }
    double getSuccessRate() const { 
        return packages.empty() ? 0.0 : (packagesDelivered * 100.0) / packages.size(); 
    }
    int getAgentsAlive() const { return agentsAlive; }
};

#endif
